<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ILA | Admin</title>
    <link rel="apple-touch-icon" href="/icon.png" />
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --brand-bg: #8c7255; --brand-text: #ffffff; }
        body { background-color: var(--brand-bg); color: var(--brand-text); font-family: 'Quicksand', sans-serif; margin: 0; padding: 0; line-height: 1.6; padding-bottom: 80px; }
        .container { width: 90%; max-width: 800px; margin: 0 auto; padding: 20px; }
        
        header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 20px; }
        .logo { max-width: 350px; height: auto; display: block; margin: 0 auto; }
        
        h2 { font-size: 1.4rem; letter-spacing: 1px; text-transform: uppercase; margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;}
        
        /* Admin Cards */
        .admin-card { background-color: rgba(0, 0, 0, 0.2); border-radius: 15px; padding: 25px; margin-bottom: 25px; border: 1px solid rgba(255, 255, 255, 0.1); }
        
        /* Forms */
        .form-group { margin-bottom: 15px; }
        .row-group { display: flex; gap: 10px; }
        label { display: block; font-size: 0.85rem; text-transform: uppercase; font-weight: bold; opacity: 0.9; margin-bottom: 5px; }
        input[type="text"], input[type="number"], input[type="password"], select { width: 100%; padding: 12px; border-radius: 8px; border: none; font-family: 'Quicksand', sans-serif; font-size: 1rem; box-sizing: border-box; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; font-weight: bold; margin-top: 10px; }
        
        /* Buttons */
        .btn { padding: 12px 20px; border-radius: 30px; border: none; font-weight: 700; font-size: 1rem; cursor: pointer; font-family: 'Quicksand', sans-serif; width: 100%; transition: opacity 0.2s; }
        .btn:active { opacity: 0.7; }
        .btn-primary { background-color: var(--brand-text); color: var(--brand-bg); }
        .btn-success { background-color: #81c784; color: white; }
        .btn-danger { background-color: #e57373; color: white; padding: 8px 15px; border-radius: 8px; font-size: 0.9rem; width: auto; font-weight: bold; cursor: pointer; border: none;}
        .btn-edit { background-color: #ffffff; color: #8c7255; padding: 8px 15px; border-radius: 8px; font-size: 0.9rem; width: auto; font-weight: bold; cursor: pointer; border: none;}
        .btn-move { background-color: rgba(255,255,255,0.2); color: white; padding: 8px 12px; border-radius: 8px; font-size: 1rem; font-weight: bold; border: none; cursor: pointer;}
        
        .btn-move-item { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 6px; cursor: pointer; padding: 5px 10px; font-size: 0.8rem; line-height: 1; transition: all 0.2s;}
        .btn-move-item:active { background: rgba(255,255,255,0.3); }

        .btn-toggle { background-color: #81c784; color: white; padding: 8px 15px; border-radius: 8px; font-size: 0.9rem; width: auto; font-weight: bold; cursor: pointer; border: none;}
        .btn-toggle.sold-out { background-color: #ffb74d; color: #333; }

        /* Master Status Button */
        #master-status-btn { font-size: 1.5rem; padding: 20px; border-radius: 15px; text-transform: uppercase; letter-spacing: 2px; }
        .status-open { background-color: #81c784; color: white; border: 3px solid #66bb6a; }
        .status-closed { background-color: #e57373; color: white; border: 3px solid #ef5350; }

        /* Lists */
        .list-item { display: flex; justify-content: space-between; align-items: center; background-color: rgba(255,255,255,0.1); padding: 12px 15px; border-radius: 8px; margin-bottom: 10px; }
        
        /* Menu Specific */
        .category-block { margin-top: 30px; }
        .category-title { font-size: 1.3rem; border-bottom: 1px dashed rgba(255,255,255,0.3); padding-bottom: 5px; margin-bottom: 15px; font-weight: bold; text-transform: uppercase;}
        .item-details { flex-grow: 1; margin-left: 15px; }
        .item-name { font-weight: bold; font-size: 1.1rem; }
        .item-meta { font-size: 0.85rem; opacity: 0.8; margin-top: 4px;}
        .item-actions { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end;}

        /* Badges */
        .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; margin-left: 10px; }
        .badge-live { background-color: rgba(129, 199, 132, 0.2); color: #81c784; }
        .badge-out { background-color: rgba(229, 115, 115, 0.2); color: #e57373; }
        .badge-vis { background-color: rgba(255, 255, 255, 0.2); color: #fff; border: 1px solid rgba(255,255,255,0.4); }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <img src="logo.png" alt="ILA Logo" class="logo">
        </header>

        <div class="admin-card" style="text-align: center;">
            <h2>Master Switch</h2>
            <p style="font-size: 0.9rem; opacity: 0.8; margin-top: -10px; margin-bottom: 15px;">Turning this off will instantly block customers from ordering on the QR Menu.</p>
            <button id="master-status-btn" class="btn" onclick="toggleCafeStatus()">Loading Status...</button>
        </div>

        <div class="admin-card">
            <h2>Menu Section Order</h2>
            <p style="font-size: 0.85rem; opacity: 0.8; margin-top: -10px; margin-bottom: 15px;">Arrange the order in which categories appear on the menu.</p>
            <div id="category-order-container">
                <p style="opacity: 0.7; font-size: 0.9rem;">Loading sections...</p>
            </div>
        </div>

        <div class="admin-card">
            <h2>Staff PIN Management</h2>
            <div class="row-group" style="margin-bottom: 15px;">
                <div class="form-group" style="flex: 2; margin: 0;">
                    <input type="text" id="staff-name" placeholder="Staff Name" required>
                </div>
                <div class="form-group" style="flex: 1; margin: 0;">
                    <input type="number" id="staff-pin" placeholder="4-Digit PIN" maxlength="4" pattern="[0-9]*" inputmode="numeric" required>
                </div>
            </div>
            <button class="btn btn-primary" onclick="addStaff()">Add / Update Staff</button>

            <div id="staff-list-container" style="margin-top: 20px;"></div>
        </div>

        <div class="admin-card" id="menu-form-section">
            <h2>Manage Menu Items</h2>
            
            <div class="form-group">
                <label>Category (e.g., Pizza, Coffee, Dessert)</label>
                <input type="text" id="add-category" placeholder="Type category name..." required>
            </div>
            
            <div class="form-group">
                <label>Item Name</label>
                <input type="text" id="add-name" placeholder="e.g., Margherita" required>
            </div>
            
            <div class="row-group">
                <div class="form-group" style="flex: 1;">
                    <label>Price (₹)</label>
                    <input type="number" id="add-price" placeholder="e.g., 400" required>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Platform Visibility</label>
                    <select id="add-visibility">
                        <option value="both" selected>Both Apps</option>
                        <option value="pos">POS Only</option>
                        <option value="customer">Customer App Only</option>
                    </select>
                </div>
            </div>

            <div class="form-group checkbox-group">
                <input type="checkbox" id="add-sweetness" style="width: 20px; height: 20px;">
                <label style="margin: 0; text-transform: none;">Requires Sweetness Level? (For Beverages)</label>
            </div>

            <button class="btn btn-primary" style="margin-top: 15px;" onclick="addMenuItem()">Save / Update Item</button>
        </div>

        <div class="admin-card" style="border: none; background: transparent; padding: 0;">
            <h2 style="text-align: center; border: none;">Live Menu Editor</h2>
            <div id="live-menu-container">
                <p style="text-align: center; opacity: 0.7;">Loading database...</p>
            </div>
        </div>

    </div>

    <script>
        // ==========================================
        // FIREBASE CLOUD CONNECTION
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAgUmy9NjbDnYXX_TBBjF8-qj36aW21qsQ",
            authDomain: "ila-cafe.firebaseapp.com",
            databaseURL: "https://ila-cafe-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ila-cafe",
            storageBucket: "ila-cafe.firebasestorage.app",
            messagingSenderId: "473595092965",
            appId: "1:473595092965:web:4ba6243e67b9ed0adb990c"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // System State
        let isCafeOpen = true;
        let currentMenuData = {};
        let currentCategoryOrder = [];
        let currentItemOrder = {}; // Stores the individual item sort order { "Pizza": ["Marg", "Fav"], "Sides": [] }

        // ==========================================
        // MASTER CAFE STATUS
        // ==========================================
        db.ref('settings/isOpen').on('value', (snapshot) => {
            const val = snapshot.val();
            isCafeOpen = val === null ? true : val; 
            
            const btn = document.getElementById('master-status-btn');
            if(isCafeOpen) {
                btn.innerText = "CAFE IS OPEN";
                btn.className = "btn status-open";
            } else {
                btn.innerText = "CAFE IS CLOSED";
                btn.className = "btn status-closed";
            }
        });

        window.toggleCafeStatus = function() {
            const newState = !isCafeOpen;
            const actionText = newState ? "OPEN" : "CLOSE";
            if(confirm(`Are you sure you want to ${actionText} the Cafe QR Menu?`)) {
                db.ref('settings/isOpen').set(newState);
            }
        };

        // ==========================================
        // ORDERING LOGIC (CATEGORIES AND ITEMS)
        // ==========================================
        
        db.ref('settings/categoryOrder').on('value', (snapshot) => {
            currentCategoryOrder = snapshot.val() || [];
            renderAllViews();
        });

        db.ref('settings/itemOrder').on('value', (snapshot) => {
            currentItemOrder = snapshot.val() || {};
            renderAllViews();
        });

        db.ref('menu').on('value', (snapshot) => {
            currentMenuData = snapshot.val() || {};
            
            let requiresCategorySave = false;
            let requiresItemSave = false;
            let categoriesInMenu = Object.keys(currentMenuData);

            // 1. Auto-Detect new Categories
            categoriesInMenu.forEach(cat => {
                if (!currentCategoryOrder.includes(cat)) {
                    currentCategoryOrder.push(cat);
                    requiresCategorySave = true;
                }
            });

            // 2. Auto-Detect new Items and cleanup deleted ones
            categoriesInMenu.forEach(cat => {
                if (!currentItemOrder[cat]) {
                    currentItemOrder[cat] = [];
                    requiresItemSave = true;
                }
                
                let itemsInCat = Object.keys(currentMenuData[cat]);
                
                // Add missing items to the end of the array
                itemsInCat.forEach(itemName => {
                    if (!currentItemOrder[cat].includes(itemName)) {
                        currentItemOrder[cat].push(itemName);
                        requiresItemSave = true;
                    }
                });

                // Clean up deleted items from the array
                let cleanOrder = currentItemOrder[cat].filter(itemName => itemsInCat.includes(itemName));
                if (cleanOrder.length !== currentItemOrder[cat].length) {
                    currentItemOrder[cat] = cleanOrder;
                    requiresItemSave = true;
                }
            });

            if (requiresCategorySave) db.ref('settings/categoryOrder').set(currentCategoryOrder);
            if (requiresItemSave) db.ref('settings/itemOrder').set(currentItemOrder);

            renderAllViews();
        });

        function getSortedCategories() {
            let activeCats = Object.keys(currentMenuData);
            return currentCategoryOrder.filter(cat => activeCats.includes(cat));
        }

        window.moveCategory = function(index, direction) {
            let cats = getSortedCategories();
            let targetIndex = index + direction;
            
            if (targetIndex < 0 || targetIndex >= cats.length) return; 
            
            let temp = cats[index];
            cats[index] = cats[targetIndex];
            cats[targetIndex] = temp;
            
            let cleanCats = cats.filter(c => c);
            db.ref('settings/categoryOrder').set(cleanCats);
        };

        window.moveItem = function(category, index, direction) {
            let arr = currentItemOrder[category];
            if (!arr) return;
            
            let targetIndex = index + direction;
            if (targetIndex < 0 || targetIndex >= arr.length) return;
            
            let temp = arr[index];
            arr[index] = arr[targetIndex];
            arr[targetIndex] = temp;
            
            db.ref('settings/itemOrder/' + category).set(arr);
        };

        // Render both the Sorter Block and the Live Editor Block
        function renderAllViews() {
            let sortedCats = getSortedCategories();
            
            // 1. Render Category Sorter Block
            let sorterContainer = document.getElementById('category-order-container');
            if (sortedCats.length === 0) {
                sorterContainer.innerHTML = "<p style='opacity: 0.7; font-size: 0.9rem;'>No categories found.</p>";
            } else {
                let sorterHTML = "";
                sortedCats.forEach((cat, index) => {
                    let upDisabled = index === 0 ? 'opacity:0.3; pointer-events:none;' : '';
                    let downDisabled = index === sortedCats.length - 1 ? 'opacity:0.3; pointer-events:none;' : '';
                    
                    sorterHTML += `
                        <div class="list-item">
                            <strong style="font-size: 1.1rem; text-transform: uppercase;">${cat}</strong>
                            <div style="display:flex; gap: 8px;">
                                <button class="btn-move" style="${upDisabled}" onclick="moveCategory(${index}, -1)">↑ Up</button>
                                <button class="btn-move" style="${downDisabled}" onclick="moveCategory(${index}, 1)">↓ Down</button>
                            </div>
                        </div>
                    `;
                });
                sorterContainer.innerHTML = sorterHTML;
            }

            // 2. Render Live Menu Editor Block (Items sorted by ItemArray)
            let menuContainer = document.getElementById('live-menu-container');
            if (Object.keys(currentMenuData).length === 0) {
                menuContainer.innerHTML = "<div class='admin-card'><p style='text-align: center; margin: 0;'>No items in menu yet.</p></div>";
                return;
            }

            let menuHTML = "";
            sortedCats.forEach(category => {
                menuHTML += `<div class="category-block"><div class="category-title">${category}</div>`;
                
                let itemsInOrder = currentItemOrder[category] || [];
                // Double check to only render items that actually exist in the database
                let validItems = itemsInOrder.filter(item => currentMenuData[category][item]);

                validItems.forEach((itemName, index) => {
                    const item = currentMenuData[category][itemName];
                    const safeCategory = category.replace(/'/g, "\\'");
                    const safeName = itemName.replace(/'/g, "\\'");
                    const safeVisibility = item.visibility ? item.visibility : 'both';
                    
                    let upDisabled = index === 0 ? 'opacity:0.3; pointer-events:none;' : '';
                    let downDisabled = index === validItems.length - 1 ? 'opacity:0.3; pointer-events:none;' : '';

                    const stockLabel = item.inStock ? "In Stock" : "Sold Out";
                    const stockBadgeClass = item.inStock ? "badge-live" : "badge-out";
                    const toggleBtnText = item.inStock ? "Mark Sold Out" : "Mark In Stock";
                    const toggleBtnClass = item.inStock ? "btn-toggle sold-out" : "btn-toggle";
                    const sweetLabel = item.requiresSweetness ? " | <i>+Sweetness Opt.</i>" : "";
                    
                    let visLabel = "Both Apps";
                    if(item.visibility === "pos") visLabel = "POS Only";
                    if(item.visibility === "customer") visLabel = "Customer App Only";

                    menuHTML += `
                        <div class="list-item" style="${!item.inStock ? 'opacity: 0.6;' : ''}">
                            <div style="display:flex; flex-direction:column; gap:4px;">
                                <button class="btn-move-item" style="${upDisabled}" onclick="moveItem('${safeCategory}', ${index}, -1)">▲</button>
                                <button class="btn-move-item" style="${downDisabled}" onclick="moveItem('${safeCategory}', ${index}, 1)">▼</button>
                            </div>
                            <div class="item-details">
                                <div class="item-name">${itemName} <span class="badge ${stockBadgeClass}">${stockLabel}</span></div>
                                <div class="item-meta">₹${item.price} <span class="badge badge-vis">${visLabel}</span> ${sweetLabel}</div>
                            </div>
                            <div class="item-actions">
                                <button class="btn-edit" onclick="editItem('${safeCategory}', '${safeName}', ${item.price}, '${safeVisibility}', ${item.requiresSweetness})">Edit</button>
                                <button class="${toggleBtnClass}" onclick="toggleStock('${safeCategory}', '${safeName}', ${item.inStock})">${toggleBtnText}</button>
                                <button class="btn-danger" onclick="deleteItem('${safeCategory}', '${safeName}')">Delete</button>
                            </div>
                        </div>
                    `;
                });
                menuHTML += `</div>`;
            });
            menuContainer.innerHTML = menuHTML;
        }

        // ==========================================
        // STAFF PIN MANAGEMENT
        // ==========================================
        window.addStaff = function() {
            const name = document.getElementById('staff-name').value.trim();
            const pin = document.getElementById('staff-pin').value.trim();

            if(!name || pin.length !== 4) {
                alert("Please enter a valid Name and a 4-Digit PIN.");
                return;
            }
            db.ref('staff/' + pin).set(name).then(() => {
                document.getElementById('staff-name').value = "";
                document.getElementById('staff-pin').value = "";
            });
        };

        window.removeStaff = function(pin, name) {
            if(confirm(`Remove ${name} from the system? Their PIN will no longer work.`)) {
                db.ref('staff/' + pin).remove();
            }
        };

        db.ref('staff').on('value', (snapshot) => {
            const staffData = snapshot.val();
            const container = document.getElementById('staff-list-container');
            container.innerHTML = "";

            if (!staffData) {
                container.innerHTML = "<p style='opacity: 0.7; font-size: 0.9rem;'>No staff PINs registered yet.</p>";
                return;
            }

            for (let pin in staffData) {
                const name = staffData[pin];
                container.innerHTML += `
                    <div class="list-item">
                        <div><strong style="font-size: 1.1rem;">${name}</strong> <span style="opacity: 0.7; margin-left: 10px;">PIN: ${pin}</span></div>
                        <button class="btn-danger" onclick="removeStaff('${pin}', '${name}')">Remove</button>
                    </div>
                `;
            }
        });

        // ==========================================
        // MENU MANAGEMENT
        // ==========================================
        window.addMenuItem = function() {
            const category = document.getElementById('add-category').value.trim();
            const name = document.getElementById('add-name').value.trim();
            const price = parseFloat(document.getElementById('add-price').value);
            const visibility = document.getElementById('add-visibility').value;
            const requiresSweetness = document.getElementById('add-sweetness').checked;

            if (!category || !name || isNaN(price)) {
                alert("Please fill in Category, Name, and Price.");
                return;
            }

            db.ref('menu/' + category + '/' + name).update({
                price: price,
                requiresSweetness: requiresSweetness,
                visibility: visibility 
            }).then(() => {
                db.ref('menu/' + category + '/' + name + '/inStock').once('value').then(snapshot => {
                    if(!snapshot.exists()) {
                        db.ref('menu/' + category + '/' + name + '/inStock').set(true);
                    }
                });

                document.getElementById('add-name').value = "";
                document.getElementById('add-price').value = "";
                document.getElementById('add-sweetness').checked = false;
                document.getElementById('add-name').focus();
            }).catch(error => {
                alert("Error saving: " + error.message);
            });
        };

        window.editItem = function(category, name, price, visibility, requiresSweetness) {
            document.getElementById('add-category').value = category;
            document.getElementById('add-name').value = name;
            document.getElementById('add-price').value = price;
            document.getElementById('add-visibility').value = visibility || "both";
            document.getElementById('add-sweetness').checked = requiresSweetness;
            
            document.getElementById('menu-form-section').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('add-price').focus();
        };

        window.toggleStock = function(category, itemName, currentStatus) {
            db.ref('menu/' + category + '/' + itemName + '/inStock').set(!currentStatus);
        };

        window.deleteItem = function(category, itemName) {
            if (confirm(`Are you sure you want to permanently delete ${itemName}?`)) {
                db.ref('menu/' + category + '/' + itemName).remove();
            }
        };

    </script>
</body>
</html>
