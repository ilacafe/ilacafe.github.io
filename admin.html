<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ILA | Admin</title>
    <link rel="apple-touch-icon" href="/icon.png" />
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --brand-bg: #8c7255; --brand-text: #ffffff; }
        body { background-color: var(--brand-bg); color: var(--brand-text); font-family: 'Quicksand', sans-serif; margin: 0; padding: 0; line-height: 1.6; padding-bottom: 80px; }
        .container { width: 90%; max-width: 800px; margin: 0 auto; padding: 20px; }
        
        header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 20px; }
        .logo { max-width: 350px; height: auto; display: block; margin: 0 auto; }
        
        h2 { font-size: 1.2rem; letter-spacing: 2px; text-transform: uppercase; margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;}
        
        .admin-card { background-color: rgba(0, 0, 0, 0.15); border-radius: 12px; padding: 25px; margin-bottom: 25px; border: 1px solid rgba(255, 255, 255, 0.1); }
        
        .form-group { margin-bottom: 15px; }
        .row-group { display: flex; gap: 10px; width: 100%; }
        label { display: block; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; opacity: 0.8; margin-bottom: 5px; }
        input[type="text"], input[type="number"], input[type="password"], select { width: 100%; padding: 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); font-family: 'Quicksand', sans-serif; font-size: 1rem; box-sizing: border-box; background: rgba(255,255,255,0.9); color: #333; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; font-weight: bold; margin-top: 10px; }
        
        .btn { padding: 12px 20px; border-radius: 6px; border: none; font-weight: 700; font-size: 1rem; cursor: pointer; font-family: 'Quicksand', sans-serif; width: 100%; transition: opacity 0.2s; text-transform: uppercase; letter-spacing: 1px; }
        .btn:active { opacity: 0.7; }
        
        .btn-primary { background-color: var(--brand-text); color: var(--brand-bg); }
        .btn-secondary { background-color: transparent; border: 1px solid var(--brand-text); color: var(--brand-text); }
        
        .btn-action { background-color: transparent; color: var(--brand-text); border: 1px solid rgba(255,255,255,0.4); padding: 6px 12px; border-radius: 4px; font-size: 0.85rem; width: auto; font-weight: bold; cursor: pointer; }
        .btn-action:active { background: rgba(255,255,255,0.1); }
        
        .btn-move { background-color: rgba(255,255,255,0.1); color: white; padding: 6px 12px; border-radius: 4px; font-size: 0.9rem; border: none; cursor: pointer; }
        .btn-move-item { background: transparent; border: none; color: rgba(255,255,255,0.6); cursor: pointer; padding: 4px; font-size: 1rem; line-height: 1;}
        .btn-move-item:active { color: white; }

        #master-status-btn { font-size: 1.2rem; padding: 15px; border-radius: 8px; }
        .status-open { background-color: var(--brand-text); color: var(--brand-bg); }
        .status-closed { background-color: transparent; color: var(--brand-text); border: 2px solid var(--brand-text); opacity: 0.8;}

        .list-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding: 12px 0; margin-bottom: 5px; }
        .list-item:last-child { border-bottom: none; }
        
        .category-block { margin-top: 30px; }
        .category-title { font-size: 1.1rem; letter-spacing: 1px; border-bottom: 1px dashed rgba(255,255,255,0.3); padding-bottom: 5px; margin-bottom: 10px; font-weight: bold; text-transform: uppercase; opacity: 0.9;}
        .item-details { flex-grow: 1; margin-left: 10px; }
        .item-name { font-weight: bold; font-size: 1.1rem; }
        .item-meta { font-size: 0.85rem; opacity: 0.7; margin-top: 2px;}
        .item-actions { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end;}

        .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: bold; text-transform: uppercase; margin-left: 10px; border: 1px solid rgba(255,255,255,0.3); }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <img src="logo.png" alt="ILA Logo" class="logo">
        </header>

        <div class="admin-card" style="text-align: center; padding: 20px;">
            <p style="font-size: 0.8rem; opacity: 0.8; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; margin-top: 0;">Master Switch</p>
            <button id="master-status-btn" class="btn" onclick="toggleCafeStatus()">Loading...</button>
        </div>

        <div class="admin-card">
            <h2>Staff PINs</h2>
            <div class="row-group" style="margin-bottom: 15px;">
                <div class="form-group" style="flex: 2; margin: 0;"><input type="text" id="staff-name" placeholder="Name" required></div>
                <div class="form-group" style="flex: 1; margin: 0;"><input type="number" id="staff-pin" placeholder="PIN" maxlength="4" pattern="[0-9]*" inputmode="numeric" required></div>
            </div>
            <button class="btn btn-secondary" onclick="addStaff()">Add Staff</button>
            <div id="staff-list-container" style="margin-top: 20px;"></div>
        </div>

        <div class="admin-card">
            <h2>Category Order</h2>
            <div id="category-order-container"><p style="opacity: 0.5; font-size: 0.9rem;">Loading...</p></div>
        </div>

        <div class="admin-card" id="menu-form-section">
            <h2>Add / Edit Item</h2>
            
            <div class="form-group"><label>Category</label><input type="text" id="add-category" placeholder="e.g., Coffee" required></div>
            <div class="form-group"><label>Item Name</label><input type="text" id="add-name" placeholder="e.g., Latte" required></div>
            
            <div class="form-group checkbox-group" style="border: 1px solid rgba(255,255,255,0.2); padding: 10px; border-radius: 6px;">
                <input type="checkbox" id="add-has-sizes" style="width: 18px; height: 18px;" onchange="toggleSizeInputs()">
                <label style="margin: 0; text-transform: none; font-size: 0.9rem; letter-spacing: 0;">Item has Regular & Large sizes</label>
            </div>

            <div class="row-group" id="single-price-group" style="display: flex;">
                <div class="form-group" style="flex: 1;"><label>Price (₹)</label><input type="number" id="add-price" placeholder="0"></div>
            </div>

            <div class="row-group" id="multi-price-group" style="display: none;">
                <div class="form-group" style="flex: 1;"><label>Regular (₹)</label><input type="number" id="add-price-reg" placeholder="0"></div>
                <div class="form-group" style="flex: 1;"><label>Large (₹)</label><input type="number" id="add-price-lrg" placeholder="0"></div>
            </div>

            <div class="form-group">
                <label>Platform Visibility</label>
                <select id="add-visibility">
                    <option value="both" selected>Both Apps</option>
                    <option value="pos">POS Only</option>
                    <option value="customer">Customer App Only</option>
                </select>
            </div>

            <div class="form-group checkbox-group">
                <input type="checkbox" id="add-sweetness" style="width: 18px; height: 18px;">
                <label style="margin: 0; text-transform: none; font-size: 0.9rem; letter-spacing: 0;">Requires Sweetness Level</label>
            </div>

            <button class="btn btn-primary" style="margin-top: 15px;" onclick="addMenuItem()">Save Item</button>
        </div>

        <div class="admin-card" style="border: none; background: transparent; padding: 0; margin-top: 30px;">
            <h2 style="border: none; padding: 0; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;">Live Menu</h2>
            <div id="live-menu-container"><p style="opacity: 0.5; margin-top: 20px;">Loading database...</p></div>
        </div>

    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAgUmy9NjbDnYXX_TBBjF8-qj36aW21qsQ",
            authDomain: "ila-cafe.firebaseapp.com",
            databaseURL: "https://ila-cafe-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ila-cafe",
            storageBucket: "ila-cafe.firebasestorage.app",
            messagingSenderId: "473595092965",
            appId: "1:473595092965:web:4ba6243e67b9ed0adb990c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let isCafeOpen = true; let currentMenuData = {}; let currentCategoryOrder = []; let currentItemOrder = {};

        db.ref('settings/isOpen').on('value', (snapshot) => {
            isCafeOpen = snapshot.val() === null ? true : snapshot.val(); 
            const btn = document.getElementById('master-status-btn');
            if(isCafeOpen) { btn.innerText = "CAFE OPEN"; btn.className = "btn status-open"; } 
            else { btn.innerText = "CAFE CLOSED"; btn.className = "btn status-closed"; }
        });

        window.toggleCafeStatus = function() { db.ref('settings/isOpen').set(!isCafeOpen); };

        db.ref('settings/categoryOrder').on('value', snap => { currentCategoryOrder = snap.val() || []; renderAllViews(); });
        db.ref('settings/itemOrder').on('value', snap => { currentItemOrder = snap.val() || {}; renderAllViews(); });

        db.ref('menu').on('value', (snapshot) => {
            currentMenuData = snapshot.val() || {};
            let requiresCategorySave = false; let requiresItemSave = false;
            let categoriesInMenu = Object.keys(currentMenuData);

            categoriesInMenu.forEach(cat => {
                if (!currentCategoryOrder.includes(cat)) { currentCategoryOrder.push(cat); requiresCategorySave = true; }
            });

            categoriesInMenu.forEach(cat => {
                if (!currentItemOrder[cat]) { currentItemOrder[cat] = []; requiresItemSave = true; }
                let itemsInCat = Object.keys(currentMenuData[cat]);
                itemsInCat.forEach(itemName => { if (!currentItemOrder[cat].includes(itemName)) { currentItemOrder[cat].push(itemName); requiresItemSave = true; } });
                let cleanOrder = currentItemOrder[cat].filter(itemName => itemsInCat.includes(itemName));
                if (cleanOrder.length !== currentItemOrder[cat].length) { currentItemOrder[cat] = cleanOrder; requiresItemSave = true; }
            });

            if (requiresCategorySave) db.ref('settings/categoryOrder').set(currentCategoryOrder);
            if (requiresItemSave) db.ref('settings/itemOrder').set(currentItemOrder);
            renderAllViews();
        });

        function getSortedCategories() { return currentCategoryOrder.filter(cat => Object.keys(currentMenuData).includes(cat)); }

        window.moveCategory = function(index, direction) {
            let cats = getSortedCategories(); let targetIndex = index + direction;
            if (targetIndex < 0 || targetIndex >= cats.length) return; 
            let temp = cats[index]; cats[index] = cats[targetIndex]; cats[targetIndex] = temp;
            db.ref('settings/categoryOrder').set(cats);
        };

        window.moveItem = function(category, index, direction) {
            let itemsInOrder = currentItemOrder[category] || Object.keys(currentMenuData[category] || {});
            let validItems = itemsInOrder.filter(item => currentMenuData[category] && currentMenuData[category][item]);
            let targetIndex = index + direction; 
            if (targetIndex < 0 || targetIndex >= validItems.length) return;
            let temp = validItems[index]; validItems[index] = validItems[targetIndex]; validItems[targetIndex] = temp;
            db.ref('settings/itemOrder/' + category).set(validItems);
        };

        function renderAllViews() {
            let sortedCats = getSortedCategories();
            
            let sorterContainer = document.getElementById('category-order-container');
            if (sortedCats.length === 0) sorterContainer.innerHTML = "<p style='opacity:0.5;'>No categories.</p>";
            else {
                let sorterHTML = "";
                sortedCats.forEach((cat, index) => {
                    let upDisabled = index === 0 ? 'opacity:0.2; pointer-events:none;' : '';
                    let downDisabled = index === sortedCats.length - 1 ? 'opacity:0.2; pointer-events:none;' : '';
                    sorterHTML += `<div class="list-item"><strong>${cat}</strong><div><button class="btn-move" style="${upDisabled}" onclick="moveCategory(${index}, -1)">↑</button> <button class="btn-move" style="${downDisabled}" onclick="moveCategory(${index}, 1)">↓</button></div></div>`;
                });
                sorterContainer.innerHTML = sorterHTML;
            }

            let menuContainer = document.getElementById('live-menu-container');
            if (Object.keys(currentMenuData).length === 0) { menuContainer.innerHTML = "<p style='opacity:0.5;'>No items.</p>"; return; }

            let menuHTML = "";
            sortedCats.forEach(category => {
                menuHTML += `<div class="category-block"><div class="category-title">${category}</div>`;
                let itemsInOrder = currentItemOrder[category] || [];
                let validItems = itemsInOrder.filter(item => currentMenuData[category][item]);

                validItems.forEach((itemName, index) => {
                    const item = currentMenuData[category][itemName];
                    const safeCategory = category.replace(/'/g, "\\'"); const safeName = itemName.replace(/'/g, "\\'");
                    const safeVisibility = item.visibility ? item.visibility : 'both';
                    
                    let upDisabled = index === 0 ? 'opacity:0.2; pointer-events:none;' : '';
                    let downDisabled = index === validItems.length - 1 ? 'opacity:0.2; pointer-events:none;' : '';

                    let statusStyle = item.inStock ? "" : "opacity: 0.5;";
                    let badgeHTML = item.inStock ? "" : `<span class="badge">Out</span>`;
                    let visLabel = item.visibility === "pos" ? "POS Only" : (item.visibility === "customer" ? "App Only" : "");
                    let visHTML = visLabel ? `<span class="badge">${visLabel}</span>` : "";
                    
                    let priceDisplay = item.hasSizes ? `₹${item.priceReg} / ₹${item.priceLrg}` : `₹${item.price}`;

                    menuHTML += `
                        <div class="list-item" style="${statusStyle}">
                            <div style="display:flex; flex-direction:column; gap:2px;">
                                <button class="btn-move-item" style="${upDisabled}" onclick="moveItem('${safeCategory}', ${index}, -1)">▲</button>
                                <button class="btn-move-item" style="${downDisabled}" onclick="moveItem('${safeCategory}', ${index}, 1)">▼</button>
                            </div>
                            <div class="item-details">
                                <div class="item-name">${itemName} ${badgeHTML}</div>
                                <div class="item-meta">${priceDisplay} ${visHTML}</div>
                            </div>
                            <div class="item-actions">
                                <button class="btn-action" onclick="editItem('${safeCategory}', '${safeName}', ${item.price || 0}, '${safeVisibility}', ${item.requiresSweetness || false}, ${item.hasSizes || false}, ${item.priceReg || 0}, ${item.priceLrg || 0})">Edit</button>
                                <button class="btn-action" onclick="toggleStock('${safeCategory}', '${safeName}', ${item.inStock})">${item.inStock ? "Hide" : "Show"}</button>
                                <button class="btn-action" style="border-color: rgba(255,255,255,0.2);" onclick="deleteItem('${safeCategory}', '${safeName}')">✖</button>
                            </div>
                        </div>`;
                });
                menuHTML += `</div>`;
            });
            menuContainer.innerHTML = menuHTML;
        }

        window.toggleSizeInputs = function() {
            if(document.getElementById('add-has-sizes').checked) {
                document.getElementById('single-price-group').style.display = 'none';
                document.getElementById('multi-price-group').style.display = 'flex';
            } else {
                document.getElementById('single-price-group').style.display = 'flex';
                document.getElementById('multi-price-group').style.display = 'none';
            }
        };

        window.addMenuItem = function() {
            const category = document.getElementById('add-category').value.trim();
            const name = document.getElementById('add-name').value.trim();
            const visibility = document.getElementById('add-visibility').value;
            const requiresSweetness = document.getElementById('add-sweetness').checked;
            const hasSizes = document.getElementById('add-has-sizes').checked;

            if (!category || !name) { alert("Please fill in Category and Name."); return; }

            let updateData = { requiresSweetness: requiresSweetness, visibility: visibility, hasSizes: hasSizes };

            if(hasSizes) {
                const pReg = parseFloat(document.getElementById('add-price-reg').value);
                const pLrg = parseFloat(document.getElementById('add-price-lrg').value);
                if(isNaN(pReg) || isNaN(pLrg)) { alert("Enter both prices."); return; }
                updateData.priceReg = pReg; updateData.priceLrg = pLrg; updateData.price = pReg; 
            } else {
                const price = parseFloat(document.getElementById('add-price').value);
                if(isNaN(price)) { alert("Enter a price."); return; }
                updateData.price = price; updateData.priceReg = null; updateData.priceLrg = null;
            }

            db.ref('menu/' + category + '/' + name).update(updateData).then(() => {
                db.ref('menu/' + category + '/' + name + '/inStock').once('value').then(snap => {
                    if(!snap.exists()) db.ref('menu/' + category + '/' + name + '/inStock').set(true);
                });
                document.getElementById('add-name').value = ""; document.getElementById('add-price').value = "";
                document.getElementById('add-price-reg').value = ""; document.getElementById('add-price-lrg').value = "";
                document.getElementById('add-name').focus();
            });
        };

        window.editItem = function(category, name, price, visibility, requiresSweetness, hasSizes, priceReg, priceLrg) {
            document.getElementById('add-category').value = category; document.getElementById('add-name').value = name; document.getElementById('add-visibility').value = visibility || "both";
            document.getElementById('add-sweetness').checked = !!requiresSweetness; document.getElementById('add-has-sizes').checked = !!hasSizes; window.toggleSizeInputs();
            if (hasSizes) { document.getElementById('add-price-reg').value = priceReg; document.getElementById('add-price-lrg').value = priceLrg; } 
            else { document.getElementById('add-price').value = price; }
            document.getElementById('menu-form-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        window.toggleStock = function(cat, name, status) { db.ref('menu/' + cat + '/' + name + '/inStock').set(!status); };
        window.deleteItem = function(cat, name) { if (confirm(`Delete ${name}?`)) db.ref('menu/' + cat + '/' + name).remove(); };
        
        db.ref('staff').on('value', (snapshot) => {
            const staffData = snapshot.val();
            const container = document.getElementById('staff-list-container');
            container.innerHTML = "";

            if (!staffData) {
                container.innerHTML = "<p style='opacity: 0.5; font-size: 0.9rem;'>No staff PINs registered.</p>";
                return;
            }

            for (let pin in staffData) {
                const name = staffData[pin];
                container.innerHTML += `
                    <div class="list-item">
                        <div><strong>${name}</strong> <span style="opacity: 0.6; margin-left: 10px; font-size: 0.9rem;">PIN: ${pin}</span></div>
                        <button class="btn-action" style="border-color: rgba(255,255,255,0.2);" onclick="removeStaff('${pin}', '${name}')">✖</button>
                    </div>
                `;
            }
        });

        window.addStaff = function() {
            const name = document.getElementById('staff-name').value.trim(); const pin = document.getElementById('staff-pin').value.trim();
            if(!name || pin.length !== 4) return;
            db.ref('staff/' + pin).set(name).then(() => { document.getElementById('staff-name').value = ""; document.getElementById('staff-pin').value = ""; });
        };
        window.removeStaff = function(pin, name) { if(confirm(`Remove ${name}?`)) db.ref('staff/' + pin).remove(); };
    </script>
</body>
</html>
