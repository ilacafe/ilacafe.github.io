<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ILA | Admin</title>
    <link rel="apple-touch-icon" href="/icon.png" />
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --brand-bg: #8c7255; --brand-text: #ffffff; }
        body { background-color: var(--brand-bg); color: var(--brand-text); font-family: 'Quicksand', sans-serif; margin: 0; padding: 0; line-height: 1.6; padding-bottom: 80px; }
        .container { width: 90%; max-width: 800px; margin: 0 auto; padding: 20px; }
        
        header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 20px; }
        .logo { max-width: 350px; height: auto; display: block; margin: 0 auto; }
        
        h2 { font-size: 1.4rem; letter-spacing: 1px; text-transform: uppercase; margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;}
        
        .admin-card { background-color: rgba(0, 0, 0, 0.2); border-radius: 15px; padding: 25px; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.1); }
        
        /* COLLAPSIBLE SECTIONS */
        details { background-color: rgba(0,0,0,0.2); border-radius: 15px; margin-bottom: 15px; padding: 10px 20px; border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s ease; }
        summary { font-size: 1.2rem; font-weight: bold; text-transform: uppercase; cursor: pointer; padding: 10px 0; outline: none; list-style: none; letter-spacing: 1px;}
        summary::-webkit-details-marker { display: none; }
        summary::after { content: '+'; float: right; font-size: 1.5rem; line-height: 1; }
        details[open] summary::after { content: '-'; }
        details > div { padding-top: 15px; border-top: 1px dashed rgba(255,255,255,0.2); margin-top: 5px; }

        .form-group { margin-bottom: 15px; }
        .row-group { display: flex; gap: 10px; width: 100%; }
        label { display: block; font-size: 0.85rem; text-transform: uppercase; font-weight: bold; opacity: 0.9; margin-bottom: 5px; }
        input[type="text"], input[type="number"], input[type="password"], select { width: 100%; padding: 12px; border-radius: 8px; border: none; font-family: 'Quicksand', sans-serif; font-size: 1rem; box-sizing: border-box; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; font-weight: bold; margin-top: 10px; }
        
        .btn { padding: 12px 20px; border-radius: 30px; border: none; font-weight: 700; font-size: 1rem; cursor: pointer; font-family: 'Quicksand', sans-serif; width: 100%; transition: opacity 0.2s; }
        .btn:active { opacity: 0.7; }
        .btn-primary { background-color: var(--brand-text); color: var(--brand-bg); }
        .btn-success { background-color: #81c784; color: white; }
        .btn-danger { background-color: #e57373; color: white; padding: 8px 15px; border-radius: 8px; font-size: 0.9rem; width: auto; font-weight: bold; cursor: pointer; border: none;}
        .btn-edit { background-color: #ffffff; color: #8c7255; padding: 8px 15px; border-radius: 8px; font-size: 0.9rem; width: auto; font-weight: bold; cursor: pointer; border: none;}
        .btn-move { background-color: rgba(255,255,255,0.2); color: white; padding: 8px 12px; border-radius: 8px; font-size: 1rem; font-weight: bold; border: none; cursor: pointer;}
        .btn-move-item { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 6px; cursor: pointer; padding: 5px 10px; font-size: 0.8rem; line-height: 1; transition: all 0.2s;}
        .btn-toggle { background-color: #81c784; color: white; padding: 8px 15px; border-radius: 8px; font-size: 0.9rem; width: auto; font-weight: bold; cursor: pointer; border: none;}
        .btn-toggle.sold-out { background-color: #ffb74d; color: #333; }

        #master-status-btn { font-size: 1.5rem; padding: 20px; border-radius: 15px; text-transform: uppercase; letter-spacing: 2px; }
        .status-open { background-color: #81c784; color: white; border: 3px solid #66bb6a; }
        .status-closed { background-color: #e57373; color: white; border: 3px solid #ef5350; }

        .list-item { display: flex; justify-content: space-between; align-items: center; background-color: rgba(255,255,255,0.1); padding: 12px 15px; border-radius: 8px; margin-bottom: 10px; }
        .category-block { margin-top: 30px; }
        .category-title { font-size: 1.3rem; border-bottom: 1px dashed rgba(255,255,255,0.3); padding-bottom: 5px; margin-bottom: 15px; font-weight: bold; text-transform: uppercase;}
        .item-details { flex-grow: 1; margin-left: 15px; }
        .item-name { font-weight: bold; font-size: 1.1rem; }
        .item-meta { font-size: 0.85rem; opacity: 0.8; margin-top: 4px;}
        .item-actions { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end;}

        .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; margin-left: 10px; }
        .badge-live { background-color: rgba(129, 199, 132, 0.2); color: #81c784; }
        .badge-out { background-color: rgba(229, 115, 115, 0.2); color: #e57373; }
        .badge-vis { background-color: rgba(255, 255, 255, 0.2); color: #fff; border: 1px solid rgba(255,255,255,0.4); }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <img src="logo.png" alt="ILA Logo" class="logo">
        </header>

        <div class="admin-card" style="text-align: center; padding: 15px 25px;">
            <p style="font-size: 0.9rem; opacity: 0.8; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; margin-top: 0;">Master Switch</p>
            <button id="master-status-btn" class="btn" onclick="toggleCafeStatus()">Loading...</button>
        </div>

        <details>
            <summary>Staff Management</summary>
            <div>
                <div class="row-group" style="margin-bottom: 15px;">
                    <div class="form-group" style="flex: 2; margin: 0;"><input type="text" id="staff-name" placeholder="Staff Name" required></div>
                    <div class="form-group" style="flex: 1; margin: 0;"><input type="number" id="staff-pin" placeholder="PIN" maxlength="4" pattern="[0-9]*" inputmode="numeric" required></div>
                </div>
                <button class="btn btn-primary" onclick="addStaff()">Add / Update Staff</button>
                <div id="staff-list-container" style="margin-top: 20px;"></div>
            </div>
        </details>

        <details>
            <summary>Category Order</summary>
            <div>
                <p style="font-size: 0.85rem; opacity: 0.8; margin-top: 0;">Arrange the order in which categories appear on the menu.</p>
                <div id="category-order-container"><p style="opacity: 0.7; font-size: 0.9rem;">Loading...</p></div>
            </div>
        </details>

        <details id="add-item-details">
            <summary>Add / Edit Item</summary>
            <div id="menu-form-section">
                <div class="form-group"><label>Category (e.g., Pizza, Coffee)</label><input type="text" id="add-category" placeholder="Type category name..." required></div>
                <div class="form-group"><label>Item Name</label><input type="text" id="add-name" placeholder="e.g., Margherita" required></div>
                
                <div class="form-group checkbox-group" style="border: 1px solid rgba(255,255,255,0.2); padding: 10px; border-radius: 8px;">
                    <input type="checkbox" id="add-has-sizes" style="width: 20px; height: 20px;" onchange="toggleSizeInputs()">
                    <label style="margin: 0; text-transform: none; font-size: 1rem;">Item has <b>Regular & Large</b> sizes?</label>
                </div>

                <div class="row-group" id="single-price-group" style="display: flex;">
                    <div class="form-group" style="flex: 1;">
                        <label>Price (â‚¹)</label>
                        <input type="number" id="add-price" placeholder="e.g., 400">
                    </div>
                </div>

                <div class="row-group" id="multi-price-group" style="display: none;">
                    <div class="form-group" style="flex: 1;">
                        <label>Regular Price (â‚¹)</label>
                        <input type="number" id="add-price-reg" placeholder="e.g., 200">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Large Price (â‚¹)</label>
                        <input type="number" id="add-price-lrg" placeholder="e.g., 300">
                    </div>
                </div>

                <div class="form-group">
                    <label>Platform Visibility</label>
                    <select id="add-visibility">
                        <option value="both" selected>Both Apps</option>
                        <option value="pos">POS Only</option>
                        <option value="customer">Customer App Only</option>
                    </select>
                </div>

                <div class="form-group checkbox-group">
                    <input type="checkbox" id="add-sweetness" style="width: 20px; height: 20px;">
                    <label style="margin: 0; text-transform: none;">Requires Sweetness Level? (For Beverages)</label>
                </div>

                <button class="btn btn-primary" style="margin-top: 15px;" onclick="addMenuItem()">Save Item</button>
            </div>
        </details>

        <div class="admin-card" style="border: none; background: transparent; padding: 0; margin-top: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;">
                <h2 style="margin: 0; border: none; padding: 0;">Live Menu</h2>
                <button class="btn btn-success" style="width: auto; padding: 6px 12px; font-size: 0.8rem;" onclick="autoFixSizes()">ðŸª„ Clean Up Drink Sizes</button>
            </div>
            
            <div id="live-menu-container"><p style="text-align: center; opacity: 0.7; margin-top: 20px;">Loading database...</p></div>
        </div>

    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAgUmy9NjbDnYXX_TBBjF8-qj36aW21qsQ",
            authDomain: "ila-cafe.firebaseapp.com",
            databaseURL: "https://ila-cafe-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ila-cafe",
            storageBucket: "ila-cafe.firebasestorage.app",
            messagingSenderId: "473595092965",
            appId: "1:473595092965:web:4ba6243e67b9ed0adb990c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let isCafeOpen = true; let currentMenuData = {}; let currentCategoryOrder = []; let currentItemOrder = {};

        db.ref('settings/isOpen').on('value', (snapshot) => {
            isCafeOpen = snapshot.val() === null ? true : snapshot.val(); 
            const btn = document.getElementById('master-status-btn');
            if(isCafeOpen) { btn.innerText = "CAFE IS OPEN"; btn.className = "btn status-open"; } 
            else { btn.innerText = "CAFE IS CLOSED"; btn.className = "btn status-closed"; }
        });

        window.toggleCafeStatus = function() { db.ref('settings/isOpen').set(!isCafeOpen); };

        db.ref('settings/categoryOrder').on('value', snap => { currentCategoryOrder = snap.val() || []; renderAllViews(); });
        db.ref('settings/itemOrder').on('value', snap => { currentItemOrder = snap.val() || {}; renderAllViews(); });

        db.ref('menu').on('value', (snapshot) => {
            currentMenuData = snapshot.val() || {};
            let requiresCategorySave = false; let requiresItemSave = false;
            let categoriesInMenu = Object.keys(currentMenuData);

            categoriesInMenu.forEach(cat => {
                if (!currentCategoryOrder.includes(cat)) { currentCategoryOrder.push(cat); requiresCategorySave = true; }
            });

            categoriesInMenu.forEach(cat => {
                if (!currentItemOrder[cat]) { currentItemOrder[cat] = []; requiresItemSave = true; }
                let itemsInCat = Object.keys(currentMenuData[cat]);
                itemsInCat.forEach(itemName => { if (!currentItemOrder[cat].includes(itemName)) { currentItemOrder[cat].push(itemName); requiresItemSave = true; } });
                let cleanOrder = currentItemOrder[cat].filter(itemName => itemsInCat.includes(itemName));
                if (cleanOrder.length !== currentItemOrder[cat].length) { currentItemOrder[cat] = cleanOrder; requiresItemSave = true; }
            });

            if (requiresCategorySave) db.ref('settings/categoryOrder').set(currentCategoryOrder);
            if (requiresItemSave) db.ref('settings/itemOrder').set(currentItemOrder);
            renderAllViews();
        });

        function getSortedCategories() { return currentCategoryOrder.filter(cat => Object.keys(currentMenuData).includes(cat)); }

        window.moveCategory = function(index, direction) {
            let cats = getSortedCategories(); let targetIndex = index + direction;
            if (targetIndex < 0 || targetIndex >= cats.length) return; 
            let temp = cats[index]; cats[index] = cats[targetIndex]; cats[targetIndex] = temp;
            db.ref('settings/categoryOrder').set(cats.filter(c => c));
        };

        window.moveItem = function(category, index, direction) {
            let arr = currentItemOrder[category]; if (!arr) return;
            let targetIndex = index + direction; if (targetIndex < 0 || targetIndex >= arr.length) return;
            let temp = arr[index]; arr[index] = arr[targetIndex]; arr[targetIndex] = temp;
            db.ref('settings/itemOrder/' + category).set(arr);
        };

        function renderAllViews() {
            let sortedCats = getSortedCategories();
            
            let sorterContainer = document.getElementById('category-order-container');
            if (sortedCats.length === 0) sorterContainer.innerHTML = "<p>No categories.</p>";
            else {
                let sorterHTML = "";
                sortedCats.forEach((cat, index) => {
                    let upDisabled = index === 0 ? 'opacity:0.3; pointer-events:none;' : '';
                    let downDisabled = index === sortedCats.length - 1 ? 'opacity:0.3; pointer-events:none;' : '';
                    sorterHTML += `<div class="list-item"><strong>${cat}</strong><div><button class="btn-move" style="${upDisabled}" onclick="moveCategory(${index}, -1)">â†‘ Up</button> <button class="btn-move" style="${downDisabled}" onclick="moveCategory(${index}, 1)">â†“ Down</button></div></div>`;
                });
                sorterContainer.innerHTML = sorterHTML;
            }

            let menuContainer = document.getElementById('live-menu-container');
            if (Object.keys(currentMenuData).length === 0) { menuContainer.innerHTML = "<div class='admin-card'><p>No items.</p></div>"; return; }

            let menuHTML = "";
            sortedCats.forEach(category => {
                menuHTML += `<div class="category-block"><div class="category-title">${category}</div>`;
                let itemsInOrder = currentItemOrder[category] || [];
                let validItems = itemsInOrder.filter(item => currentMenuData[category][item]);

                validItems.forEach((itemName, index) => {
                    const item = currentMenuData[category][itemName];
                    const safeCategory = category.replace(/'/g, "\\'"); const safeName = itemName.replace(/'/g, "\\'");
                    const safeVisibility = item.visibility ? item.visibility : 'both';
                    
                    let upDisabled = index === 0 ? 'opacity:0.3; pointer-events:none;' : '';
                    let downDisabled = index === validItems.length - 1 ? 'opacity:0.3; pointer-events:none;' : '';

                    const stockLabel = item.inStock ? "In Stock" : "Sold Out";
                    const stockBadgeClass = item.inStock ? "badge-live" : "badge-out";
                    const toggleBtnClass = item.inStock ? "btn-toggle sold-out" : "btn-toggle";
                    const sweetLabel = item.requiresSweetness ? " | <i>+Sweetness Opt.</i>" : "";
                    
                    let priceDisplay = item.hasSizes ? `â‚¹${item.priceReg} (Reg) / â‚¹${item.priceLrg} (Lrg)` : `â‚¹${item.price}`;
                    let visLabel = item.visibility === "pos" ? "POS Only" : (item.visibility === "customer" ? "Customer App Only" : "Both Apps");

                    menuHTML += `
                        <div class="list-item" style="${!item.inStock ? 'opacity: 0.6;' : ''}">
                            <div style="display:flex; flex-direction:column; gap:4px;">
                                <button class="btn-move-item" style="${upDisabled}" onclick="moveItem('${safeCategory}', ${index}, -1)">â–²</button>
                                <button class="btn-move-item" style="${downDisabled}" onclick="moveItem('${safeCategory}', ${index}, 1)">â–¼</button>
                            </div>
                            <div class="item-details">
                                <div class="item-name">${itemName} <span class="badge ${stockBadgeClass}">${stockLabel}</span></div>
                                <div class="item-meta">${priceDisplay} <span class="badge badge-vis">${visLabel}</span> ${sweetLabel}</div>
                            </div>
                            <div class="item-actions">
                                <button class="btn-edit" onclick="editItem('${safeCategory}', '${safeName}', ${item.price || 0}, '${safeVisibility}', ${item.requiresSweetness || false}, ${item.hasSizes || false}, ${item.priceReg || 0}, ${item.priceLrg || 0})">Edit</button>
                                <button class="${toggleBtnClass}" onclick="toggleStock('${safeCategory}', '${safeName}', ${item.inStock})">${item.inStock ? "Sold Out" : "In Stock"}</button>
                                <button class="btn-danger" onclick="deleteItem('${safeCategory}', '${safeName}')">Del</button>
                            </div>
                        </div>`;
                });
                menuHTML += `</div>`;
            });
            menuContainer.innerHTML = menuHTML;
        }

        // ==========================================
        // MAGIC FIX BUTTON (Merges Sizes)
        // ==========================================
        window.autoFixSizes = function() {
            if(!confirm("This will automatically find and merge all your '(Reg)' and '(Lrg)' drinks into clean, single items. Continue?")) return;

            db.ref('menu').once('value').then(snap => {
                const menu = snap.val();
                if(!menu) return;

                for(let cat in menu) {
                    let items = menu[cat];
                    let toDelete = [];
                    let newItems = {};

                    for(let itemName in items) {
                        let item = items[itemName];
                        // Look for our old naming conventions
                        let regMatch = itemName.match(/(.*)\s\((Regular|Reg)\)$/i);
                        let lrgMatch = itemName.match(/(.*)\s\((Large|Lrg)\)$/i);

                        if(regMatch || lrgMatch) {
                            let base = regMatch ? regMatch[1] : lrgMatch[1];
                            
                            if(!newItems[base]) {
                                newItems[base] = {
                                    hasSizes: true,
                                    inStock: true,
                                    requiresSweetness: item.requiresSweetness || false,
                                    visibility: item.visibility || 'both'
                                };
                            }
                            
                            // Map the prices
                            if(regMatch) newItems[base].priceReg = item.price || item.priceReg;
                            if(lrgMatch) newItems[base].priceLrg = item.price || item.priceLrg;
                            
                            newItems[base].price = newItems[base].priceReg || 0; // Fallback

                            toDelete.push(itemName);
                        }
                    }

                    // Upload merged items
                    for(let base in newItems) {
                        db.ref(`menu/${cat}/${base}`).set(newItems[base]);
                    }
                    // Delete the old messy items
                    toDelete.forEach(oldName => {
                        db.ref(`menu/${cat}/${oldName}`).remove();
                    });
                }

                // Reset the item sorting array so it generates fresh
                db.ref('settings/itemOrder').remove();

                alert("Cleanup complete! Refreshing dashboard...");
                setTimeout(() => location.reload(), 1000);
            });
        };

        window.toggleSizeInputs = function() {
            if(document.getElementById('add-has-sizes').checked) {
                document.getElementById('single-price-group').style.display = 'none';
                document.getElementById('multi-price-group').style.display = 'flex';
            } else {
                document.getElementById('single-price-group').style.display = 'flex';
                document.getElementById('multi-price-group').style.display = 'none';
            }
        };

        window.addMenuItem = function() {
            const category = document.getElementById('add-category').value.trim();
            const name = document.getElementById('add-name').value.trim();
            const visibility = document.getElementById('add-visibility').value;
            const requiresSweetness = document.getElementById('add-sweetness').checked;
            const hasSizes = document.getElementById('add-has-sizes').checked;

            if (!category || !name) { alert("Please fill in Category and Name."); return; }

            let updateData = { requiresSweetness, visibility, hasSizes };

            if(hasSizes) {
                const pReg = parseFloat(document.getElementById('add-price-reg').value);
                const pLrg = parseFloat(document.getElementById('add-price-lrg').value);
                if(isNaN(pReg) || isNaN(pLrg)) { alert("Enter both Regular and Large prices."); return; }
                updateData.priceReg = pReg; updateData.priceLrg = pLrg; updateData.price = pReg; 
            } else {
                const price = parseFloat(document.getElementById('add-price').value);
                if(isNaN(price)) { alert("Enter a price."); return; }
                updateData.price = price; updateData.priceReg = null; updateData.priceLrg = null;
            }

            db.ref('menu/' + category + '/' + name).update(updateData).then(() => {
                db.ref('menu/' + category + '/' + name + '/inStock').once('value').then(snap => {
                    if(!snap.exists()) db.ref('menu/' + category + '/' + name + '/inStock').set(true);
                });
                document.getElementById('add-name').value = ""; document.getElementById('add-price').value = "";
                document.getElementById('add-price-reg').value = ""; document.getElementById('add-price-lrg').value = "";
                document.getElementById('add-name').focus();
            });
        };

        window.editItem = function(category, name, price, visibility, requiresSweetness, hasSizes, priceReg, priceLrg) {
            document.getElementById('add-item-details').open = true; // Open the folder automatically
            document.getElementById('add-category').value = category;
            document.getElementById('add-name').value = name;
            document.getElementById('add-visibility').value = visibility || "both";
            document.getElementById('add-sweetness').checked = !!requiresSweetness;
            document.getElementById('add-has-sizes').checked = !!hasSizes;
            window.toggleSizeInputs();

            if (hasSizes) {
                document.getElementById('add-price-reg').value = priceReg;
                document.getElementById('add-price-lrg').value = priceLrg;
            } else {
                document.getElementById('add-price').value = price;
            }
            document.getElementById('add-item-details').scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        window.toggleStock = function(cat, name, status) { db.ref('menu/' + cat + '/' + name + '/inStock').set(!status); };
        window.deleteItem = function(cat, name) { if (confirm(`Delete ${name}?`)) db.ref('menu/' + cat + '/' + name).remove(); };
        
        window.addStaff = function() {
            const name = document.getElementById('staff-name').value.trim(); const pin = document.getElementById('staff-pin').value.trim();
            if(!name || pin.length !== 4) return;
            db.ref('staff/' + pin).set(name).then(() => { document.getElementById('staff-name').value = ""; document.getElementById('staff-pin').value = ""; });
        };
        window.removeStaff = function(pin, name) { if(confirm(`Remove ${name}?`)) db.ref('staff/' + pin).remove(); };
    </script>
</body>
</html>
