<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ILA | Order</title>
    <link rel="apple-touch-icon" href="/icon-customer.png" />
    <link rel="icon" type="image/png" href="/icon-customer.png" />
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --brand-bg: #8c7255; --brand-text: #ffffff; }
        body { background-color: var(--brand-bg); color: var(--brand-text); font-family: 'Quicksand', sans-serif; margin: 0; padding: 0; line-height: 1.6; display: flex; flex-direction: column; align-items: center; padding-bottom: 120px; }
        .container { width: 90%; max-width: 600px; margin: 0 auto; padding: 20px; }
        header { text-align: center; margin-bottom: 20px; }
        
        .logo { max-width: 350px; height: auto; display: block; margin: 0 auto; transition: transform 0.7s cubic-bezier(0.25, 1, 0.5, 1); cursor: pointer; -webkit-tap-highlight-color: transparent; }

        h2 { font-weight: 700; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 2px; text-align: center; margin-top: 30px; margin-bottom: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding-bottom: 10px; }
        
        /* RESTORED & FIXED: Single Line Rigid Grid */
        .menu-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 1.1rem; font-weight: 500; }
        .item-name { flex-grow: 1; padding-right: 10px; line-height: 1.2; }
        .price-group { display: flex; align-items: center; justify-content: flex-end; gap: 8px; }
        
        .price-fixed { width: 42px; text-align: right; font-size: 1rem; opacity: 0.9; }
        .inline-container { width: 72px; display: flex; justify-content: flex-end; }

        .add-btn { background-color: transparent; color: var(--brand-text); border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 4px; width: 30px; height: 30px; font-size: 1.4rem; font-weight: 400; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; padding: 0; line-height: 1; }
        .add-btn:active { background-color: var(--brand-text); color: var(--brand-bg); }
        .add-btn:disabled { opacity: 0.2; cursor: not-allowed; border-color: transparent; }

        .qty-ctrl { display: flex; align-items: center; border: 1px solid rgba(255,255,255,0.4); border-radius: 4px; height: 30px; width: 72px; box-sizing: border-box; }
        .qty-btn { background: transparent; color: white; border: none; width: 24px; height: 100%; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; transition: all 0.2s; line-height: 1; }
        .qty-btn:active { background: white; color: var(--brand-bg); }
        .qty-num { width: 24px; text-align: center; font-weight: bold; font-size: 1rem; }

        .sold-out-badge { font-size: 0.65rem; color: rgba(255,255,255,0.6); border: 1px solid rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 4px; margin-left: 8px; text-transform: uppercase; font-weight: bold; }

        .coffee-header { display: grid; grid-template-columns: 1fr max-content max-content; gap: 8px; font-weight: 700; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; opacity: 0.6; border-bottom: 1px dashed rgba(255, 255, 255, 0.2); padding-bottom: 5px; }
        .coffee-row { display: grid; grid-template-columns: 1fr max-content max-content; gap: 8px; align-items: center; margin-bottom: 15px; font-size: 1.1rem; font-weight: 500; }
        .coffee-price { display: flex; align-items: center; justify-content: flex-end; gap: 8px; }

        .contact-footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1); width: 100%; text-align: center; }
        .footer-links { display: flex; flex-direction: row; flex-wrap: wrap; justify-content: center; align-items: center; gap: 12px; font-size: 0.85rem; opacity: 0.7; }
        .contact-link { color: var(--brand-text); text-decoration: none; }

        #cart-banner { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--brand-text); color: var(--brand-bg); padding: 15px 20px calc(15px + env(safe-area-inset-bottom)); box-sizing: border-box; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); transform: translateY(100%); transition: transform 0.3s ease; z-index: 1000; cursor: pointer;}
        #cart-banner.visible { transform: translateY(0); }
        .cart-info { display: flex; flex-direction: column; flex-grow: 1;}
        .cart-total { font-weight: 700; font-size: 1.1rem; }
        .cart-clear { font-size: 0.8rem; opacity: 0.7; margin-top: 2px; }
        .checkout-btn { background-color: var(--brand-bg); color: var(--brand-text); border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; font-family: 'Quicksand', sans-serif; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;}

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: var(--brand-bg); border: 1px solid rgba(255,255,255,0.2); padding: 25px 20px; border-radius: 12px; text-align: center; width: 85%; max-width: 400px; max-height: 85vh; overflow-y: auto; }
        .modal-content h3 { margin-top: 0; font-size: 1.2rem; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px;}
        
        .remark-input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid rgba(255,255,255,0.4); font-family: 'Quicksand', sans-serif; font-size: 1rem; background-color: transparent; color: white; display: block; box-sizing: border-box; outline: none;}
        .remark-input::placeholder { color: rgba(255,255,255,0.4); }
        
        .choice-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
        .type-row { display: flex; gap: 8px; margin-top: 8px; }
        .choice-btn { background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; padding: 12px 5px; border-radius: 6px; font-family: 'Quicksand', sans-serif; font-size: 0.9rem; text-transform: uppercase; cursor: pointer; font-weight: bold; transition: all 0.2s; flex: 1;}
        .choice-btn.selected { background: white; color: var(--brand-bg); border-color: white;}
        
        .table-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 8px; }
        .table-btn { background-color: transparent; color: white; border: 1px solid rgba(255,255,255,0.4); padding: 12px 0; border-radius: 6px; font-weight: bold; font-size: 1.1rem; cursor: pointer; font-family: 'Quicksand', sans-serif; transition: all 0.2s;}
        .table-btn.selected { background-color: white; color: var(--brand-bg); border-color: white; }

        .modal-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .btn { padding: 12px 15px; border-radius: 6px; font-weight: bold; font-size: 0.95rem; cursor: pointer; font-family: 'Quicksand', sans-serif; flex: 1; border: none; text-transform: uppercase; letter-spacing: 1px;}
        .btn-primary { background-color: var(--brand-text); color: var(--brand-bg); }
        .btn-secondary { background-color: transparent; color: var(--brand-text); border: 1px solid var(--brand-text); }
        
        .mini-btn { background-color: transparent; border: 1px solid rgba(255,255,255,0.4); color: white; border-radius: 4px; width: 28px; height: 28px; font-size: 1.2rem; cursor: pointer; margin: 0 5px; display: flex; align-items: center; justify-content: center; padding: 0; transition: all 0.2s; }
        .mini-btn:active { background-color: white; color: var(--brand-bg); }

        .close-modal { background: transparent; color: rgba(255,255,255,0.8); border: none; font-weight: bold; cursor: pointer; font-size: 0.85rem; font-family: 'Quicksand', sans-serif; margin-top: 20px; letter-spacing: 1px; padding: 10px;}

        .bill-receipt { background-color: transparent; border: 1px solid rgba(255,255,255,0.2); color: white; padding: 15px; border-radius: 8px; text-align: left; font-size: 0.95rem; }
        .bill-receipt-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px dashed rgba(255,255,255,0.2); padding-bottom: 10px; }
        .bill-receipt-row:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0;}

        #closed-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--brand-bg); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 3000; text-align: center; padding: 20px; box-sizing: border-box; }
        
        .usual-box { border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px; padding: 15px; cursor: pointer; text-align: center; transition: background-color 0.2s; margin-bottom: 25px; }
        .usual-box:active { background-color: rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body>

    <div id="closed-screen">
        <img src="logo.png" alt="ILA Logo" style="max-width: 200px; margin-bottom: 20px;">
        <h1 style="text-transform: uppercase; font-size: 1.5rem; letter-spacing: 2px;">Closed</h1>
        <p style="opacity: 0.7; font-size: 1rem;">We are currently not accepting orders.</p>
    </div>

    <div class="container">
        <header>
            <img src="logo.png" alt="ILA Logo" class="logo" onclick="this.style.transform = `rotate(${this.rotation = (this.rotation || 0) + 360}deg)`">
        </header>

        <div id="usual-order-container" style="display: none;">
            <div class="usual-box" onclick="window.loadUsualOrder()">
                <div style="font-weight: 700; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px;">Reorder Your Usual</div>
                <div id="usual-order-desc" style="font-size: 0.9rem; opacity: 0.7;"></div>
            </div>
        </div>

        <div id="live-menu-container">
            <p style="text-align: center; opacity: 0.5; margin-top: 50px;">Loading...</p>
        </div>

        <div class="contact-footer">
            <div class="footer-links">
                <a href="https://wa.me/918882946526" class="contact-link" target="_blank">+91 88829 46526</a>
                <span class="footer-divider">|</span>
                <a href="https://instagram.com/ila_cafe" class="contact-link" target="_blank">@ila_cafe</a>
            </div>
        </div>
    </div>

    <div id="cart-banner" onclick="window.openCheckoutModal()">
        <div class="cart-info">
            <span class="cart-total" id="cart-total-text">₹0</span>
            <span class="cart-clear">View Order</span>
        </div>
        <button class="checkout-btn">Checkout</button>
    </div>

    <div id="remark-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="remark-item-title">Item</h3>
            <div style="text-align: left; width: 100%; margin: 15px 0;">
                <label style="color: white; font-size: 0.8rem; text-transform: uppercase; font-weight: bold; opacity: 0.8;">Sweetness</label>
                <div class="choice-grid">
                    <button class="choice-btn selected" onclick="window.selectSweetness('Medium sweet', this)">Medium</button>
                    <button class="choice-btn" onclick="window.selectSweetness('No sweetness', this)">None</button>
                    <button class="choice-btn" onclick="window.selectSweetness('Less sweet', this)">Less</button>
                    <button class="choice-btn" onclick="window.selectSweetness('Very sweet', this)">Extra</button>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal('remark-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="window.confirmAddItem()">Add</button>
            </div>
            <button class="close-modal" onclick="closeModal('remark-modal')">✖ CLOSE</button>
        </div>
    </div>

    <div id="checkout-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Cart</h3>
            <div id="review-cart-list" class="bill-receipt" style="max-height: 200px; overflow-y: auto;"></div>
            <div style="font-weight: bold; font-size: 1.3rem; margin: 15px 0; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px;">Total: ₹<span id="modal-checkout-total">0</span></div>

            <div style="text-align: left; margin-top: 15px;">
                <div style="margin-bottom: 15px;">
                    <label style="font-size: 0.8rem; text-transform: uppercase; font-weight: bold; opacity: 0.8;">Special Requests</label>
                    <textarea id="cart-notes" class="remark-input" placeholder="e.g. Oat milk, extra napkins..." style="height: 50px; resize: none; margin-top: 5px;"></textarea>
                </div>

                <label style="font-size: 0.8rem; text-transform: uppercase; font-weight: bold; opacity: 0.8;">Order Type</label>
                <div class="type-row">
                    <button class="choice-btn selected" id="type-dinein" onclick="window.setOrderType('Dine-in')">Dine-in</button>
                    <button class="choice-btn" id="type-takeaway" onclick="window.setOrderType('Takeaway')">Takeaway</button>
                    <button class="choice-btn" id="type-delivery" onclick="window.setOrderType('Delivery')">Delivery</button>
                </div>
                
                <div id="dynamic-fields" style="margin-top: 15px;">
                    <div id="field-dinein" style="display: block;">
                        <label style="font-size: 0.8rem; text-transform: uppercase; font-weight: bold; opacity: 0.8;">Table Number</label>
                        <div class="table-grid" id="customer-table-grid"></div>
                    </div>
                    <div id="field-delivery" style="display: none;">
                        <textarea id="delivery-address" class="remark-input" placeholder="Delivery Address..." style="height: 60px; resize: none; margin-top: 0;"></textarea>
                    </div>
                    <div id="field-takeaway" style="display: none; text-align: center; padding: 10px 0;">
                        <div style="font-weight: bold; font-size: 1rem;">Pickup: <span id="time-display">30</span> min</div>
                        <input type="range" id="takeaway-time" min="10" max="90" step="5" value="30" oninput="document.getElementById('time-display').innerText = this.value" style="-webkit-appearance: none; width: 100%; background: rgba(255,255,255,0.4); border-radius: 2px; height: 2px; margin-top: 10px; outline: none;">
                    </div>
                </div>
            </div>

            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="window.clearCart()">Empty</button>
                <button class="btn btn-primary" onclick="window.proceedToPayment()">Pay</button>
            </div>
            <button class="close-modal" onclick="closeModal('checkout-modal')">✖ CLOSE</button>
        </div>
    </div>

    <div id="payment-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Checkout</h3>
            <div style="border: 1px solid rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-size: 0.8rem; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px;">Amount Due</div>
                <div style="font-size: 1.8rem; font-weight: 700;">₹<span id="payment-amount">0</span></div>
            </div>
            
            <button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" id="pay-upi-btn">Pay via UPI</button>
            <img id="payment-qr" src="" alt="QR" style="width: 150px; height: 150px; margin: 0 auto 15px auto; border-radius: 8px; display: block; background: white; padding: 5px;">
            
            <div id="payment-instruction" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.6; margin-bottom: 15px;">
                Complete payment above to send order
            </div>

            <button class="btn btn-secondary" id="confirm-order-btn" style="width: 100%; display: none;" onclick="window.sendCustomerOrder()">I Have Paid - Send Order</button>
            
            <button class="close-modal" onclick="closeModal('payment-modal')">✖ CLOSE</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAgUmy9NjbDnYXX_TBBjF8-qj36aW21qsQ",
            authDomain: "ila-cafe.firebaseapp.com",
            databaseURL: "https://ila-cafe-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ila-cafe",
            storageBucket: "ila-cafe.firebasestorage.app",
            messagingSenderId: "473595092965",
            appId: "1:473595092965:web:4ba6243e67b9ed0adb990c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const OWNER_WHATSAPP = "918882946526"; 
        const CAFE_UPI_ID = "sraveen.chirania-1@okaxis"; 
        
        window.cart = JSON.parse(localStorage.getItem('ila_customer_cart')) || {}; 
        window.totalAmount = parseFloat(localStorage.getItem('ila_customer_amount')) || 0;
        window.totalItems = parseInt(localStorage.getItem('ila_customer_items')) || 0;
        
        window.lastOrder = JSON.parse(localStorage.getItem('ila_last_order')) || null;
        window.lastAmount = parseFloat(localStorage.getItem('ila_last_amount')) || 0;
        window.lastAddress = localStorage.getItem('ila_last_address') || "";
        window.currentOrderType = localStorage.getItem('ila_last_order_type') || "Dine-in";

        const tableGrid = document.getElementById('customer-table-grid');
        for(let i=1; i<=10; i++) { tableGrid.innerHTML += `<button class="table-btn" onclick="window.setDineInTable('${i}', this)">${i}</button>`; }
        
        if (window.lastAddress) document.getElementById('delivery-address').value = window.lastAddress;

        if (window.lastOrder && Object.keys(window.lastOrder).length > 0) {
            document.getElementById('usual-order-container').style.display = 'block';
            let desc = Object.keys(window.lastOrder).map(k => `${window.lastOrder[k].qty}x ${k}`).join(', ');
            document.getElementById('usual-order-desc').innerText = `${desc} — ₹${window.lastAmount}`;
        }
        
        window.pendingItemName = ""; window.pendingItemPrice = 0; window.currentOrderInfo = null;
        window.currentSweetness = "Medium sweet"; window.currentDineInTable = "";
        let currentMenuData = {}; let currentCategoryOrder = []; window.currentItemOrder = {};
        window.flatMenu = {}; 

        function saveCart() { 
            localStorage.setItem('ila_customer_cart', JSON.stringify(window.cart)); 
            localStorage.setItem('ila_customer_amount', window.totalAmount); 
            localStorage.setItem('ila_customer_items', window.totalItems); 
            updateCartUI(); 
        }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        function updateCartUI() {
            const banner = document.getElementById('cart-banner');
            if (window.totalItems > 0) { document.getElementById('cart-total-text').innerText = `₹${window.totalAmount}`; banner.classList.add('visible'); } 
            else { banner.classList.remove('visible'); }
            window.renderInlineControls(); 
        }

        window.getCartQty = function(baseName) {
            let qty = 0; let realBaseName = baseName.replace(/&quot;/g, '"').replace(/\\'/g, "'");
            for (let key in window.cart) {
                if (key === realBaseName || key.startsWith(realBaseName + " (")) { qty += window.cart[key].qty; }
            }
            return qty;
        };

        window.renderInlineControls = function() {
            const containers = document.querySelectorAll('.inline-container');
            containers.forEach(container => {
                let safeName = container.getAttribute('data-item');
                let price = container.getAttribute('data-price');
                let reqSweet = container.getAttribute('data-sweet') === 'true';
                let qty = window.getCartQty(safeName);
                
                if (qty > 0) {
                    container.innerHTML = `<div class="qty-ctrl"><button class="qty-btn" onclick="window.decrementInline('${safeName}')">-</button><span class="qty-num">${qty}</span><button class="qty-btn" onclick="window.promptRemark('${safeName}', ${price}, ${reqSweet})">+</button></div>`;
                } else {
                    container.innerHTML = `<button class="add-btn" onclick="window.promptRemark('${safeName}', ${price}, ${reqSweet})">+</button>`;
                }
            });
        };

        window.decrementInline = function(safeName) {
            let realBaseName = safeName.replace(/&quot;/g, '"').replace(/\\'/g, "'");
            let targetKey = null;
            for (let key in window.cart) {
                if (key === realBaseName || key.startsWith(realBaseName + " (")) { targetKey = key; break; }
            }
            if (targetKey) {
                window.cart[targetKey].qty -= 1; window.totalAmount -= window.cart[targetKey].price; window.totalItems -= 1;
                if (window.cart[targetKey].qty <= 0) delete window.cart[targetKey];
                saveCart();
                if (window.totalItems === 0) closeModal('checkout-modal'); 
                else if (document.getElementById('checkout-modal').classList.contains('active')) window.openCheckoutModal();
            }
        };

        db.ref('settings/isOpen').on('value', snap => {
            const isOpen = snap.val(); const lockScreen = document.getElementById('closed-screen');
            if (isOpen === false) { lockScreen.style.display = "flex"; document.body.style.overflow = "hidden"; } 
            else { lockScreen.style.display = "none"; document.body.style.overflow = "auto"; }
        });

        db.ref('settings/categoryOrder').on('value', snap => { currentCategoryOrder = snap.val() || []; renderCustomerMenu(); });
        db.ref('settings/itemOrder').on('value', snap => { window.currentItemOrder = snap.val() || {}; renderCustomerMenu(); });
        db.ref('menu').on('value', snap => { currentMenuData = snap.val() || {}; renderCustomerMenu(); });

        function renderCustomerMenu() {
            const container = document.getElementById('live-menu-container');
            if (Object.keys(currentMenuData).length === 0) { container.innerHTML = "<p style='text-align: center; opacity:0.5;'>Menu updating...</p>"; return; }
            container.innerHTML = ""; window.flatMenu = {};

            let activeCats = Object.keys(currentMenuData);
            let sortedCats = currentCategoryOrder.filter(cat => activeCats.includes(cat));
            activeCats.forEach(cat => { if(!sortedCats.includes(cat)) sortedCats.push(cat); });

            sortedCats.forEach(category => {
                let standardItems = []; let sizedItems = []; let hasVisibleItems = false;
                let itemsInOrder = window.currentItemOrder[category] || Object.keys(currentMenuData[category] || {});
                
                itemsInOrder.forEach(itemName => {
                    const item = currentMenuData[category] ? currentMenuData[category][itemName] : null;
                    if (!item || item.visibility === 'pos') return; 
                    hasVisibleItems = true; item.originalName = itemName; 
                    if (item.hasSizes) { 
                        sizedItems.push(item);
                        window.flatMenu[itemName + " (Regular)"] = { price: item.priceReg, inStock: item.inStock };
                        window.flatMenu[itemName + " (Large)"] = { price: item.priceLrg, inStock: item.inStock };
                    } else { 
                        standardItems.push(item); 
                        window.flatMenu[itemName] = { price: item.price, inStock: item.inStock };
                    }
                });

                if (!hasVisibleItems) return;
                let catHTML = `<section><h2>${category}</h2>`;

                standardItems.forEach(item => {
                    const safeName = item.originalName.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                    if (item.inStock) {
                        catHTML += `<div class="menu-row"><span class="item-name">${item.originalName}</span><div class="price-group"><span class="price-fixed">₹${item.price || 0}</span><div id="ctrl-${safeName}" class="inline-container" data-item="${safeName}" data-price="${item.price || 0}" data-sweet="${item.requiresSweetness || false}"></div></div></div>`;
                    } else {
                        catHTML += `<div class="menu-row" style="opacity: 0.4;"><span class="item-name">${item.originalName} <span class="sold-out-badge">Out</span></span><div class="price-group"><span class="price-fixed">₹${item.price || 0}</span><button class="add-btn" disabled>+</button></div></div>`;
                    }
                });

                if (sizedItems.length > 0) {
                    // Restored single-line header
                    catHTML += `<div class="coffee-header"><div></div><div style="text-align: right; padding-right: 15px;">Reg</div><div style="text-align: right; padding-right: 15px;">Lrg</div></div>`;
                    sizedItems.forEach(item => {
                        let safeNameReg = (item.originalName + " (Regular)").replace(/'/g, "\\'").replace(/"/g, "&quot;");
                        let safeNameLrg = (item.originalName + " (Large)").replace(/'/g, "\\'").replace(/"/g, "&quot;");
                        let regHTML = `<span class="sold-out-badge" style="margin:0; border:none;">-</span>`;
                        let lrgHTML = `<span class="sold-out-badge" style="margin:0; border:none;">-</span>`;

                        if (item.inStock) {
                            if(item.priceReg) regHTML = `<div class="coffee-price"><span class="price-fixed">₹${item.priceReg}</span><div class="inline-container" data-item="${safeNameReg}" data-price="${item.priceReg}" data-sweet="${item.requiresSweetness || false}"></div></div>`; else regHTML = '-';
                            if(item.priceLrg) lrgHTML = `<div class="coffee-price"><span class="price-fixed">₹${item.priceLrg}</span><div class="inline-container" data-item="${safeNameLrg}" data-price="${item.priceLrg}" data-sweet="${item.requiresSweetness || false}"></div></div>`; else lrgHTML = '-';
                        }
                        catHTML += `<div class="coffee-row" style="${!item.inStock ? 'opacity: 0.4;' : ''}"><span>${item.originalName}</span>${regHTML}${lrgHTML}</div>`;
                    });
                }
                catHTML += `</section>`;
                container.innerHTML += catHTML;
            });
            window.renderInlineControls(); 
        }

        window.validateAndSyncCart = function(cartObj) {
            let validCart = {}; let newTotal = 0; let newCount = 0; let changed = false; let removed = [];
            let menuKeys = Object.keys(window.flatMenu).sort((a,b) => b.length - a.length);

            for(let cartKey in cartObj) {
                let matchedMenuKey = menuKeys.find(key => cartKey.startsWith(key));
                let liveData = window.flatMenu[matchedMenuKey];

                if(liveData && liveData.inStock) {
                    if(cartObj[cartKey].price !== liveData.price) changed = true;
                    validCart[cartKey] = { price: liveData.price, qty: cartObj[cartKey].qty };
                    newTotal += (liveData.price * cartObj[cartKey].qty);
                    newCount += cartObj[cartKey].qty;
                } else {
                    changed = true; removed.push(cartKey);
                }
            }
            return { cart: validCart, total: newTotal, count: newCount, changed: changed, removed: removed };
        };

        window.loadUsualOrder = function() {
            if(Object.keys(window.flatMenu).length === 0) return alert("Menu syncing, please try again in a second.");
            let result = window.validateAndSyncCart(window.lastOrder);
            
            if(result.removed.length > 0) {
                alert("Sorry, some items in your usual order are currently out of stock:\n- " + result.removed.join("\n- "));
                if(result.count === 0) return; 
            }
            
            window.cart = result.cart; window.totalAmount = result.total; window.totalItems = result.count;
            saveCart(); window.setOrderType(window.lastOrderType || 'Dine-in');
            window.openCheckoutModal();
        };

        window.selectSweetness = function(val, btn) {
            window.currentSweetness = val;
            let siblings = btn.parentNode.children;
            for(let s of siblings) s.classList.remove('selected');
            btn.classList.add('selected');
        };

        window.promptRemark = function(itemName, price, requiresSweetness = false) {
            let finalName = itemName.replace(/&quot;/g, '"');
            if (!requiresSweetness) {
                if (window.cart[finalName]) window.cart[finalName].qty += 1; 
                else window.cart[finalName] = { price: price, qty: 1 };
                window.totalAmount += price; window.totalItems += 1;
                if (navigator.vibrate) navigator.vibrate(50);
                saveCart(); return;
            }

            window.pendingItemName = itemName; window.pendingItemPrice = price; 
            document.getElementById('remark-item-title').innerText = finalName; 
            
            window.currentSweetness = "Medium sweet";
            const btns = document.querySelectorAll('#remark-modal .choice-grid .choice-btn');
            btns.forEach(b => b.classList.remove('selected'));
            btns[0].classList.add('selected');

            document.getElementById('remark-modal').classList.add('active');
        };

        window.confirmAddItem = function() {
            let finalName = window.pendingItemName.replace(/&quot;/g, '"'); 
            if (window.currentSweetness !== "") finalName += ` (${window.currentSweetness})`;
            if (window.cart[finalName]) window.cart[finalName].qty += 1; else window.cart[finalName] = { price: window.pendingItemPrice, qty: 1 };
            window.totalAmount += window.pendingItemPrice; window.totalItems += 1;
            saveCart(); closeModal('remark-modal');
        };

        window.clearCart = function() { window.cart = {}; window.totalAmount = 0; window.totalItems = 0; saveCart(); closeModal('checkout-modal'); };

        window.openCheckoutModal = function() {
            if (window.totalItems === 0) return alert("Your cart is empty!");
            
            let result = window.validateAndSyncCart(window.cart);
            if(result.changed) {
                window.cart = result.cart; window.totalAmount = result.total; window.totalItems = result.count;
                saveCart();
                if(result.removed.length > 0) {
                    alert("Cart updated: Some items are no longer available and were removed.");
                    if(window.totalItems === 0) return;
                }
            }

            const list = document.getElementById('review-cart-list'); list.innerHTML = "";
            for (let item in window.cart) {
                const safeItemName = item.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                list.innerHTML += `<div class="bill-receipt-row"><span style="flex:1;">${item}</span><span style="display:flex; align-items:center;"><button class="mini-btn" onclick="window.modifyCartItem('${safeItemName}', -1)">-</button><span style="width:24px; text-align:center;">${window.cart[item].qty}</span><button class="mini-btn" onclick="window.modifyCartItem('${safeItemName}', 1)">+</button></span></div>`;
            }
            
            document.getElementById('cart-notes').value = "";
            document.getElementById('modal-checkout-total').innerText = window.totalAmount;
            
            window.setOrderType(window.currentOrderType);
            document.getElementById('checkout-modal').classList.add('active');
        };

        window.modifyCartItem = function(item, delta) {
            let realItemName = item.replace(/&quot;/g, '"');
            if (window.cart[realItemName]) {
                window.cart[realItemName].qty += delta; window.totalAmount += (window.cart[realItemName].price * delta); window.totalItems += delta;
                if (window.cart[realItemName].qty <= 0) delete window.cart[realItemName];
                saveCart();
                if (window.totalItems === 0) closeModal('checkout-modal'); else window.openCheckoutModal(); 
            }
        };

        window.setOrderType = function(type) {
            window.currentOrderType = type;
            document.getElementById('type-dinein').classList.remove('selected');
            document.getElementById('type-takeaway').classList.remove('selected');
            document.getElementById('type-delivery').classList.remove('selected');
            document.getElementById('type-' + type.toLowerCase().replace('-', '')).classList.add('selected');
            window.updateDynamicFields();
        };

        window.setDineInTable = function(num, btn) {
            window.currentDineInTable = num;
            let siblings = btn.parentNode.children;
            for(let s of siblings) s.classList.remove('selected');
            btn.classList.add('selected');
        };

        window.updateDynamicFields = function() {
            const type = window.currentOrderType;
            document.getElementById('field-delivery').style.display = type === 'Delivery' ? 'block' : 'none';
            document.getElementById('field-dinein').style.display = type === 'Dine-in' ? 'block' : 'none';
            document.getElementById('field-takeaway').style.display = type === 'Takeaway' ? 'block' : 'none';
        };

        window.proceedToPayment = function() {
            const type = window.currentOrderType; let details = "";
            const notes = document.getElementById('cart-notes').value.trim().replace(/</g, "&lt;").replace(/>/g, "&gt;");

            if (type === 'Delivery') { details = document.getElementById('delivery-address').value.trim(); if (details.length < 5) { alert("Address required."); return; } } 
            else if (type === 'Dine-in') { if (!window.currentDineInTable) { alert("Please select a table number."); return; } details = "Table " + window.currentDineInTable; } 
            else if (type === 'Takeaway') { const time = document.getElementById('takeaway-time').value; details = `Pickup: ${time} min`; }

            window.currentOrderInfo = { type, details, notes };
            closeModal('checkout-modal');
            document.getElementById('payment-amount').innerText = window.totalAmount;
            
            const upiString = `upi://pay?pa=${CAFE_UPI_ID}&pn=ILA&am=${window.totalAmount}&cu=INR`;
            document.getElementById('payment-qr').src = `https://quickchart.io/qr?size=250&text=${encodeURIComponent(upiString)}`;
            
            document.getElementById('confirm-order-btn').style.display = 'none';
            document.getElementById('payment-instruction').style.display = 'block';

            document.getElementById('pay-upi-btn').onclick = () => { 
                window.location.href = upiString; 
                setTimeout(() => {
                    document.getElementById('payment-instruction').style.display = 'none';
                    document.getElementById('confirm-order-btn').style.display = 'block';
                }, 1500);
            };
            
            document.getElementById('payment-modal').classList.add('active');
        };

        window.sendCustomerOrder = function() {
            const info = window.currentOrderInfo; 
            
            localStorage.setItem('ila_last_order', JSON.stringify(window.cart));
            localStorage.setItem('ila_last_amount', window.totalAmount);
            localStorage.setItem('ila_last_order_type', info.type); 
            if (info.type === 'Delivery') { localStorage.setItem('ila_last_address', document.getElementById('delivery-address').value.trim()); }

            let message = `ORDER: ${info.type.toUpperCase()}\n${info.details}\n`;
            if (info.notes) { message += `Notes: ${info.notes}\n`; }
            message += `\n`;
            
            for (let item in window.cart) { message += `${window.cart[item].qty}x ${item}\n`; }
            message += `\nTotal: ₹${window.totalAmount}\nStatus: Customer UPI`;
            setTimeout(() => { window.cart = {}; window.totalAmount = 0; window.totalItems = 0; saveCart(); closeModal('payment-modal'); window.location.href = `https://wa.me/${OWNER_WHATSAPP}?text=${encodeURIComponent(message)}`; }, 100);
        };

        updateCartUI(); window.updateDynamicFields();
    </script>
</body>
</html>
